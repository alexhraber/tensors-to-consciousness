services:
  explorer:
    build:
      context: .
      dockerfile: Dockerfile
    image: tensors-to-consciousness:dev
    working_dir: /workspace
    command: ["explorer"]
    stdin_open: true
    tty: true
    environment:
      TERM: ${TERM:-xterm-256color}
      COLORTERM: ${COLORTERM:-truecolor}
    volumes:
      - ./:/workspace
      - explorer_config:/workspace/.explorer

  explorer-nvidia:
    profiles: ["gpu", "nvidia"]
    build:
      context: .
      dockerfile: Dockerfile
    image: tensors-to-consciousness:dev
    working_dir: /workspace
    command: ["explorer"]
    stdin_open: true
    tty: true
    gpus: all
    group_add:
      - video
      - render
    devices:
      - /dev/dri:/dev/dri
    environment:
      TERM: ${TERM:-xterm-256color}
      COLORTERM: ${COLORTERM:-truecolor}
      NVIDIA_VISIBLE_DEVICES: ${NVIDIA_VISIBLE_DEVICES:-all}
      NVIDIA_DRIVER_CAPABILITIES: ${NVIDIA_DRIVER_CAPABILITIES:-compute,utility,graphics}
    volumes:
      - ./:/workspace
      - explorer_config:/workspace/.explorer

  explorer-amd:
    profiles: ["gpu", "amd"]
    build:
      context: .
      dockerfile: Dockerfile
    image: tensors-to-consciousness:dev
    working_dir: /workspace
    command: ["explorer"]
    stdin_open: true
    tty: true
    group_add:
      - video
      - render
    devices:
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    environment:
      TERM: ${TERM:-xterm-256color}
      COLORTERM: ${COLORTERM:-truecolor}
      HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-}
    volumes:
      - ./:/workspace
      - explorer_config:/workspace/.explorer

  explorer-intel:
    profiles: ["gpu", "intel"]
    build:
      context: .
      dockerfile: Dockerfile
    image: tensors-to-consciousness:dev
    working_dir: /workspace
    command: ["explorer"]
    stdin_open: true
    tty: true
    group_add:
      - video
      - render
    devices:
      - /dev/dri:/dev/dri
    environment:
      TERM: ${TERM:-xterm-256color}
      COLORTERM: ${COLORTERM:-truecolor}
    volumes:
      - ./:/workspace
      - explorer_config:/workspace/.explorer

  explorer-apple:
    profiles: ["apple"]
    build:
      context: .
      dockerfile: Dockerfile
    image: tensors-to-consciousness:dev
    platform: linux/arm64
    working_dir: /workspace
    command: ["explorer", "tui", "--framework", "mlx"]
    stdin_open: true
    tty: true
    environment:
      TERM: ${TERM:-xterm-256color}
      COLORTERM: ${COLORTERM:-truecolor}
    volumes:
      - ./:/workspace
      - explorer_config:/workspace/.explorer

volumes:
  explorer_config:
